<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Formulario con QR</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: Arial; margin: 30px; background: #f5f5f5; }
    #reader { width: 320px; margin: auto; }
    form { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 6px #ccc; max-width: 350px; margin: auto; }
    input, button { width: 100%; padding: 10px; margin-top: 10px; border-radius: 5px; border: 1px solid #ccc; }
    button { background: #007bff; color: white; border: none; }
  </style>
</head>
<body>
  <h2>Formulario con Escáner QR</h2>

  <form id="qrForm">
    <label>Número de empleado:</label>
    <input type="text" id="empleado" placeholder="Ingresa tu número" required />

    <label>Código (por cámara):</label>
    <div id="reader"></div>
    <input type="text" id="codigo" placeholder="Esperando escaneo..." readonly />

    <button type="submit">Enviar</button>
  </form>

  <script>
    const form = document.getElementById("qrForm");
    const empleadoInput = document.getElementById("empleado");
    const codigoInput = document.getElementById("codigo");
    const readerDiv = document.getElementById("reader");

    // Inicializa el escáner
    const html5QrCode = new Html5Qrcode("reader");

    function startScanner() {
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        qrCodeMessage => {
          codigoInput.value = qrCodeMessage;
          html5QrCode.stop(); // Detiene la cámara tras leer
        },
        errorMessage => { console.log(errorMessage); }
      ).catch(err => {
        alert("Error al iniciar cámara: " + err);
      });
    }

    startScanner();

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const data = {
        empleado: empleadoInput.value,
        codigo: codigoInput.value
      };

      try {
        const response = await fetch("https://script.google.com/a/macros/liverpool.com.mx/s/AKfycbwVyjQEB_BoF73EcFQHGHWtEP4LrSU6XM4E9j96gLswmGbo_c7W6cyeO4rl8aJJdTPJ/exec", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });
        const result = await response.json();
        if (result.result === "success") {
          alert("✅ Registro guardado correctamente");
          form.reset();
          startScanner();
        } else {
          alert("❌ Error al guardar: " + result.message);
        }
      } catch (err) {
        alert("Error al enviar los datos: " + err);
      }
    });
  </script>
</body>
</html>
